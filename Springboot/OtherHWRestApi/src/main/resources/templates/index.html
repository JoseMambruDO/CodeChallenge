<!doctype html>
<html lang="en">
<head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
  integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

<title>OtherHWRestApi</title>
</head>
<body>

  <nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <ul class="navbar-nav">
      <li class="nav-item active"><a class="nav-link" href="#">OtherHWRestApi</a></li>
      <li class="nav-item"><a class="nav-link" href="/product">Product</a></li>
      <li class="nav-item"><a class="nav-link" href="/category">Category</a></li>

    </ul>
  </nav>

  <div class="container-fluid">
    <h3>Products</h3>
    <input id="inputproducts" type="text" placeholder="Looking product" onkeyup="app.findproducts()">

    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#detailProduct"
      onclick="app.clearForAdding();">Create new Product</button>

    <table id="table" class="table" width="border:1px;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Category</th>
          <th>Cost</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id='tb_products'>

      </tbody>
    </table>

  </div>

  <!-- Product Detail -->

  <!-- Modal Detail-->
  <div class="modal fade" id="detailProduct" tabindex="-1" role="dialog" aria-labelledby="detailProductLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailProductLabel">Product</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">

          <div class="form-group">
            <label for="fc_id">ID </label>
            <input id="fc_id" name="fc_id"  class="form-control"  placeholder="id" readonly="readonly" type="text" />
          </div>
          <div class="form-group">
            <label for="fc_name">Name</label>
            <input id="fc_name" name="fc_name" class="form-control" required="required" placeholder="name" type="text" />
          </div>

          <div class="form-group">

            <label for="fc_id">Category </label>
            <select id="fc_category" class="form-control"  ></select>
          </div>

          <div class="form-group">

            <label for="fc_cost">Cost</label>
            <input id="fc_cost" name="fc_cost"  class="form-control"  placeholder="cost" type="number" step="any">
          </div>

          <div class="form-group">

            <label for="fc_price">Price</label>
            <input id="fc_price" type="number" step="any" class="form-control"  placeholder="price">
          </div>

          <div class="form-group">

            <label for="fc_quantity">Quantity</label>
            <input id="fc_quantity" type="number" step="any" min="0" class="form-control"  placeholder="Quantity">
          </div>

          <div class="form-group">

            <label for="fc_description">Description</label>
            <textarea rows="4" cols="20" id="fc_description" class="form-control"  ></textarea>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="app.save()">Save</button>
        </div>
      </div>
    </div>
  </div>


  <script>
			var srcproducts = '/api/v1/products';
			var currRow = {};

			var app = new function() {

				this.save = function() {
					var productName = document.getElementById("fc_name").value;
					var productCategory = document
							.getElementById("fc_category").value;
					var productCost = document.getElementById("fc_cost").value;
					var productPrice = document.getElementById("fc_price").value;
					var productQuantity = document
							.getElementById("fc_quantity").value;
					var productDescription = document
							.getElementById("fc_description").value;

					if (!validatField()) {
						alert("Product entity is not valid");

					} else {

						switch (state) {
						case "ADDING":
							this.addProduct();
							break;
						case "EDITING":
							this.editProduct();
							break;
						case "DELETING":
							this.deleteProduct();
							break;

						}

						$("#detailProduct").modal('hide');
					}
				}

				function validatField() {
					productName = document.getElementById("fc_name").value;
					return (productName !== "");

				}
				this.clearDetail = function() {

					document.getElementById("fc_id").value = "";
					document.getElementById("fc_name").value = "";
					document.getElementById("fc_category").value = "";
					document.getElementById("fc_cost").value = "";
					document.getElementById("fc_price").value = "";
					document.getElementById("fc_quantity").value = "";
					document.getElementById("fc_description").value = "";

					$("#detailProductLabel").text('Product ' + state);
				}

				this.clearForAdding = function() {
					state = "ADDING";
					rederListCategory();
					this.clearDetail();
				}

				function renderHTML() {
					if (currRow !== {}) {

						document.getElementById("fc_id").value = currRow['id'];
						document.getElementById("fc_name").value = currRow['name'];
						rederListCategory();
						document.getElementById("fc_category").value = currRow['category']['id'];
						document.getElementById("fc_cost").value = currRow['cost'];
						document.getElementById("fc_price").value = currRow['price'];
						document.getElementById("fc_quantity").value = currRow['quantity'];
						document.getElementById("fc_description").value = currRow['description'];

						$("#detailProductLabel").text('Product ' + state);
						$("#detailProduct").modal('show');

					}
				}

				this.preEditing = function(id) {
					state = "EDITING";
					this.getProduct(id, cbf, renderHTML);

				}

				function cbf(dataCR, act) {
					currRow = dataCR;
					act();
				}

				this.preDeleting = function(id) {
					state = "DELETING";
					this.getProduct(id, cbf, renderHTML);
				}

				this.getProduct = function(id, cb, act) {

					var url = srcproducts + "/findByID/" + id;
					curRow = {};
					var xhr = new XMLHttpRequest();
					xhr.onload = function() {
						if (xhr.status >= 200 && xhr.status < 300) {

							var data = JSON.parse(this.responseText);

							data = (data.content || data);

							cb(data, act);

						} else {
							result = 'The request failed!';
						}

					};
					xhr.open('GET', url);
					xhr.send();

				}

				this.addProduct = function() {

					dataProduct = {};
					dataProduct.name = document.getElementById('fc_name').value;
					dataProduct.category = {};
					dataProduct.category.id = document
							.getElementById("fc_category").value;
					dataProduct.description = document
							.getElementById("fc_description").value;
					dataProduct.cost = document.getElementById("fc_cost").value;
					dataProduct.price = document.getElementById("fc_price").value;
					dataProduct.quantity = document
							.getElementById("fc_quantity").value;

					dataProduct.description = document
							.getElementById("fc_description").value;
					var json = JSON.stringify(dataProduct);
					var xhr = new XMLHttpRequest();
					xhr.open("POST", srcproducts, true);
					xhr.setRequestHeader('Content-type',
							'application/json; charset=utf-8');
					xhr.onload = function() {

						if (xhr.status == "200") {
							app.findproducts();
							console.log("Product was added.");
						} else {
							console
									.log("Something wrong, adding a new Product.");
						}
					}
					xhr.send(json);

					this.findproducts();
				}

				this.editProduct = function() {

					dataProduct = {};

					dataProduct.id = document.getElementById('fc_id').value;

					dataProduct.name = document.getElementById('fc_name').value;

					dataProduct.category = {};
					dataProduct.category.id = document
							.getElementById("fc_category").value;

					dataProduct.cost = document.getElementById("fc_cost").value;
					dataProduct.price = document.getElementById("fc_price").value;
					dataProduct.quantity = document
							.getElementById("fc_quantity").value;

					dataProduct.description = document
							.getElementById("fc_description").value;

					var url = srcproducts + "/" + dataProduct.id

					var json = JSON.stringify(dataProduct);
					var xhr = new XMLHttpRequest();
					xhr.open("PUT", url, true);
					xhr.setRequestHeader('Content-type',
							'application/json; charset=utf-8');
					xhr.onload = function() {

						if (xhr.status == "200") {
							app.findproducts();
							console.log("Product was Edited.");

						} else {
							console.log("Something wrong, editing a Product.");
						}
					}
					xhr.send(json);
				}

				function rederListCategory() {

					var url = "/api/v1/categories";

					var xhr = new XMLHttpRequest();
					xhr.onload = function() {
						if (xhr.status >= 200 && xhr.status < 300) {

							var data = JSON.parse(this.responseText);

							data = (data.content || data);

							var out = '';
							for (i = 0; i < data.length; i++) {
								out += '<option value='+data[i].id+'>'
										+ data[i].name + '</option>';
							}
							document.getElementById('fc_category').innerHTML = out;
						} else {
							result = 'The request failed!';
						}

					};
					xhr.open('GET', url);
					xhr.send();

				}

				this.deleteProduct = function() {

					dataProduct = {};
					dataProduct.id = document.getElementById('fc_id').value;

					var url = srcproducts + "/" + dataProduct.id
					var xhr = new XMLHttpRequest();
					xhr.open("DELETE", url, true);
					xhr.setRequestHeader('Content-type',
							'text/plain; charset=utf-8');

					xhr.onload = function() {

						if (xhr.status == "200") {
							app.findproducts();
							console.log("Product was Edited.");

						} else {
							console
									.log("Something wrong, deleting a new Product.");
						}
					}

					xhr.send();

				}
				
		         
				this.findproducts = function() {

					//getting value for filtering
					var el = document.getElementById('inputproducts');

					var value = (el.innerText || el.textContent || el.value);

					var url = srcproducts;

					if (value !== '') {
						url = srcproducts + '/findByName/' + value;
					}

					var xhr = new XMLHttpRequest();
					xhr.onload = function() {
						if (xhr.status >= 200 && xhr.status < 300) {

							var data = JSON.parse(this.responseText);

							data = (data.content || data);

							var out = '';
							for (i = 0; i < data.length; i++) {
								out += '<tr>';
								out += '<td>' + data[i].id + '</td>';
								out += '<td>' + data[i].name + '</td>';
								out += '<td>' + data[i].category.name + '</td>';
								out += '<td>' + data[i].cost + '</td>';
								out += '<td>' + data[i].price + '</td>';
								
								var qtyStatus = '';
                                if (data[i].quantity < 10) {
                                    qtyStatus = ' style="color:red;"';
                                }
								
								out += '<td>' + data[i].quantity +  qtyStatus+ '</td>';

								
								
								out += '<td><a id="rw' + data[i].id
										+ '" href="#" ' + data[i].id
										+ '" onclick="app.preEditing('
										+ data[i].id + ')">Edit</a>';
								out += '<a id="rw' + data[i].id + '" href="#" '
										+ data[i].id
										+ '" onclick="app.preDeleting('
										+ data[i].id + ')">Delete</a>';
								out += '</td>';

								out += '<tr>';
							}
							document.getElementById('tb_products').innerHTML = out;
						} else {
							result = 'The request failed!';
						}

					};
					xhr.open('GET', url);
					xhr.send();

				};

			}

			app.findproducts();
		</script>


  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</body>
</html>